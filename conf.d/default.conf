# error_log  /var/log/nginx/error.log;

lua_package_path "/workspace/lib/?.lua;;";

init_worker_by_lua_block {    
    local resty_roundrobin = require "resty.roundrobin"    

    local atom_up = resty_roundrobin:new({["65.108.30.59"]=100,["18.138.176.63"]=100,["104.245.147.194"]=100})

    local osmo_up = resty_roundrobin:new({["188.166.220.245"]=100,["34.66.189.218"]=100,["216.250.252.46"]=100})

    local inj_up = resty_roundrobin:new({["162.55.65.206"]=100,["46.4.102.29"]=100,["49.12.148.144"]=100})

    package.loaded.delay = 5  -- in seconds as block time    
    package.loaded.atom_up = atom_up
    package.loaded.osmo_up = osmo_up
    package.loaded.inj_up = inj_up

    local function check(premature)
         if not premature then
             -- do the health check or other routine work
             local ok, err = ngx.timer.at(package.loaded.delay, check)
             if not ok then
                 ngx.log(ngx.ERR, "failed to create timer: ", err)
                 return
             end
         end        
        atom_up:update()
        osmo_up:update()
        inj_up:update()
    end

    local hdl, err = ngx.timer.at(0, check)
    if not hdl then
         ngx.log(ngx.ERR, "failed to create timer: ", err)
         return
    end                
    
}

upstream rpc_atom {
    server 0.0.0.1;
    balancer_by_lua_block {
        assert(require("ngx.balancer").set_current_peer(package.loaded.atom_up:next(), 26657))
    }
}

upstream rpc_osmo {
    server 0.0.0.1;
    balancer_by_lua_block {
        assert(require("ngx.balancer").set_current_peer(package.loaded.osmo_up:next(), 26657))
    }
}

upstream rpc_inj {
    server 0.0.0.1;
    balancer_by_lua_block {
        assert(require("ngx.balancer").set_current_peer(package.loaded.inj_up:next(), 26657))
    }
}

server {    
    set $template_root /var/www/templates;
    location /_watom/ {
        root html;
        default_type 'text/html';
        content_by_lua_block {
            local template = require "resty.template"
            local atom_up = package.loaded.atom_up
            template.render("view.html", {          
                heights = atom_up.heights,
                nodes = atom_up.nodes,   
                max_height = atom_up:get_max_height(),
                interval = package.loaded.delay,
                network = "cosmoshub-4",
                link = "https://mintscan.io", 
            })
        }
    }

    location /_wosmo/ {
        root html;
        default_type 'text/html';
        content_by_lua_block {
            local template = require "resty.template"
            local osmo_up = package.loaded.osmo_up
            template.render("view.html", {          
                heights = osmo_up.heights,
                nodes = osmo_up.nodes,   
                max_height = osmo_up:get_max_height(),
                interval = package.loaded.delay,
                network = "osmosis-1",
                link = "https://mintscan.io", 
            })
        }
    }
    
    location /_winj/ {
        root html;
        default_type 'text/html';
        content_by_lua_block {
            local template = require "resty.template"
            local inj_up = package.loaded.inj_up
            template.render("view.html", {          
                heights = inj_up.heights,
                nodes = inj_up.nodes,   
                max_height = inj_up:get_max_height(),
                interval = package.loaded.delay,
                network = "injective-1",
                link = "https://mintscan.io", 
            })
        }
    }
}

server {
    server_name cosmos-rpc-global.orai.io;
    location / {
        proxy_pass http://rpc_atom;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
server {
    server_name osmosis-rpc-global.orai.io;
    location / {
        proxy_pass http://rpc_osmo;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
server {
    server_name injective-rpc-global.orai.io;
    location / {
        proxy_pass http://rpc_inj;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
